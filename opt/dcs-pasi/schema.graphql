schema @site(type: "pasi:pred/type") {
  query: Query
  mutation: Mutation
}


"---------------------------- Mutations ----------------------------"

type Mutation {

  upsertZwsCarbonMetric(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/ZwsCarbonMetric/{{wasteStream}}"
        }
      )
    wasteStream: String! @site(a: "pasi:pred/wasteStream")
    carbonWeighting: Float! @site(a: "pasi:pred/carbonWeighting")
  ): ZwsCarbonMetric @site(mutation: "update")

  upsertAceFurnitureDescription(
    # I'm likely to replace this composite key approach to enforcing a uniqueness contraint,
    # by a test-and-set function that can check any constraints while transacting.
    # (Alex suggests implementing that by using juxt-site's put-code stuff or his WIP lambda stuff.)
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/AceFurnitureDescription/{{category}}/{{subcategory}}"
        }
      )
    category: String! @site(a: "pasi:pred/category")
    subcategory: String! @site(a: "pasi:pred/subcategory")
    itemKg: Float! @site(a: "pasi:pred/itemKg")
  ): AceFurnitureDescription @site(mutation: "update")

  upsertAceReusedFurniture(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/AceReusedFurniture/{{from}}/{{to}}/{{category}}/{{subcategory}}"
        }
      )
      from: Date! @site(a: "pasi:pred/from")
      to: Date! @site(a: "pasi:pred/to")
      category: String! @site(a: "pasi:pred/category")
      subcategory: String! @site(a: "pasi:pred/subcategory")
      description: ID 
        @site(
          a: "pasi:pred/description"
          gen: {
            type: TEMPLATE 
            template: "pasi:ent/AceFurnitureDescription/{{category}}/{{subcategory}}"
          }
        )
      itemCount: Int! @site(a: "pasi:pred/itemCount")
  ): AceReusedFurniture @site(mutation: "update")

  upsertStcmfSource(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/StcmfSource/{{name}}"
        }
      )
    name: String! @site(a: "pasi:pred/name")
  ): StcmfSource @site(mutation: "update")

  upsertStcmfDestination(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/StcmfDestination/{{name}}"
        }
      )
    name: String! @site(a: "pasi:pred/name")
  ): StcmfDestination @site(mutation: "update")

  upsertStcmfIncomingFood(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/StcmfIncomingFood/{{from}}/{{to}}/{{source}}"
        }
      )
      from: Date! @site(a: "pasi:pred/from")
      to: Date! @site(a: "pasi:pred/to")
      source: String!
      sourceRef: ID 
        @site(
          a: "pasi:pred/source"
          gen: {
            type: TEMPLATE 
            template: "pasi:ent/StcmfSource/{{source}}"
          }
        )
      batchKg: Float! @site(a: "pasi:pred/batchKg")
  ): StcmfIncomingFood @site(mutation: "update")

  upsertStcmfRedistributedFood(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/StcmfRedistributedFood/{{from}}/{{to}}/{{destination}}"
        }
      )
      from: Date! @site(a: "pasi:pred/from")
      to: Date! @site(a: "pasi:pred/to")
      destination: String!
      destinationRef: ID 
        @site(
          a: "pasi:pred/destination"
          gen: {
            type: TEMPLATE 
            template: "pasi:ent/StcmfDestination/{{destination}}"
          }
        )
      batchKg: Float! @site(a: "pasi:pred/batchKg")
  ): StcmfRedistributedFood @site(mutation: "update")

  upsertFrshrMaterialCategory(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/FrshrMaterialCategory/{{name}}"
        }
      )
    name: String! @site(a: "pasi:pred/name")
  ): FrshrMaterialCategory @site(mutation: "update")

  upsertFrshrReusedMaterial(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/FrshrReusedMaterial/{{from}}/{{to}}/{{material}}"
        }
      )
      from: Date! @site(a: "pasi:pred/from")
      to: Date! @site(a: "pasi:pred/to")
      material: String!
      materialRef: ID 
        @site(
          a: "pasi:pred/material"
          gen: {
            type: TEMPLATE 
            template: "pasi:ent/FrshrMaterialCategory/{{material}}"
          }
        )
      batchKg: Float! @site(a: "pasi:pred/batchKg")
  ): FrshrReusedMaterial @site(mutation: "update")

  upsertOpsAceToRefData(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsAceToRefData/{{category}}/{{subcategory}}/{{refMaterial}}"
        }
      )
    category: String!
    subcategory: String!
    description: ID 
      @site(
        a: "pasi:pred/description"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/AceFurnitureDescription/{{category}}/{{subcategory}}"
        }
      )
    fraction: Float! @site(a: "pasi:pred/fraction")
    refProcess: String!
    refProcessRef: ID 
      @site(
        a: "pasi:pred/refProcess"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsProcess/{{refProcess}}"
        }
      )
    refMaterial: String!
    refMaterialRef: ID 
      @site(
        a: "pasi:pred/refMaterial"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/ZwsCarbonMetric/{{refMaterial}}"
        }
      )
    enabler: String!
    enablerRef: ID 
      @site(
        a: "pasi:pred/enabler"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsOrg/{{enabler}}"
        }
      )
  ): OpsAceToRefData @site(mutation: "update")

  upsertOpsStcmfToRefData(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsStcmfToRefData/{{destination}}/{{refProcess}}/{{refMaterial}}"
        }
      )
    destination: String!
    destinationRef: ID 
      @site(
        a: "pasi:pred/destination"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/StcmfDestination/{{destination}}"
        }
      )
    fraction: Float! @site(a: "pasi:pred/fraction")
    refProcess: String!
    refProcessRef: ID 
      @site(
        a: "pasi:pred/refProcess"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsProcess/{{refProcess}}"
        }
      )
    refMaterial: String!
    refMaterialRef: ID 
      @site(
        a: "pasi:pred/refMaterial"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/ZwsCarbonMetric/{{refMaterial}}"
        }
      )
    enabler: String!
    enablerRef: ID 
      @site(
        a: "pasi:pred/enabler"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsOrg/{{enabler}}"
        }
      )
  ): OpsStcmfToRefData @site(mutation: "update")

  upsertOpsFrshrToRefData(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsFrshrToRefData/{{material}}/{{refProcess}}/{{refMaterial}}"
        }
      )
    material: String!
    materialRef: ID 
      @site(
        a: "pasi:pred/material"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/FrshrMaterialCategory/{{material}}"
        }
      )
    fraction: Float! @site(a: "pasi:pred/fraction")
    refProcess: String!
    refProcessRef: ID 
      @site(
        a: "pasi:pred/refProcess"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsProcess/{{refProcess}}"
        }
      )
    refMaterial: String!
    refMaterialRef: ID 
      @site(
        a: "pasi:pred/refMaterial"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/ZwsCarbonMetric/{{refMaterial}}"
        }
      )
    enabler: String!
    enablerRef: ID 
      @site(
        a: "pasi:pred/enabler"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsOrg/{{enabler}}"
        }
      )
  ): OpsFrshrToRefData @site(mutation: "update")

  upsertOpsOrg(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsOrg/{{abbr}}"
        }
      )
    abbr: String! @site(a: "pasi:pred/abbr")
    name: String! @site(a: "pasi:pred/name")
    qid: String @site(a: "pasi:pred/qid")
  ): OpsOrg @site(mutation: "update")

  upsertOpsProcess(
    id: ID
      @site(
        a: "xt/id"
        gen: {
          type: TEMPLATE 
          template: "pasi:ent/OpsProcess/{{name}}"
        }
      )
    name: String! @site(a: "pasi:pred/name")
  ): OpsProcess @site(mutation: "update")

  # Just an example of a delete - not yet used
  deleteOpsProcess(
    id: ID!
  ): OpsProcess @site(mutation: "delete")

}


"---------------------------- Queries ----------------------------"

type Query {
  zwsCarbonMetric: [ZwsCarbonMetric]!
  aceFurnitureDescription: [AceFurnitureDescription]!
  aceReusedFurniture: [AceReusedFurniture]!
  stcmfSource: [StcmfSource]!
  stcmfDestination: [StcmfDestination]!
  stcmfIncomingFood: [StcmfIncomingFood]!
  stcmfRedistributedFood: [StcmfRedistributedFood]!
  frshrMaterialCategory: [FrshrMaterialCategory]!
  frshrReusedMaterial: [FrshrReusedMaterial]!
  opsAceToRefData: [OpsAceToRefData]!
  opsStcmfToRefData: [OpsStcmfToRefData]!
  opsFrshrToRefData: [OpsFrshrToRefData]!
  opsOrg: [OpsOrg]!
  opsProcess: [OpsProcess]!
  opsWasteReduction: [OpsWasteReduction]!
    @site(
      q: {
        edn:
        """
        {:find [e]
          :where [(or [e :pasi:pred/type "AceReusedFurniture"]
                      [e :pasi:pred/type "StcmfRedistributedFood"]
                      [e :pasi:pred/type "FrshrReusedMaterial"])]
         }
        """}
    )
}


"---------------------------- Types ----------------------------"

# java.time.LocalDate ?
scalar Date

"""
ZWS carbon metric
"""
type ZwsCarbonMetric {
  id: ID!
  "The waste stream (material classification)"
  wasteStream: String! @site(a: "pasi:pred/wasteStream")
  "A weight multiplier for calculating carbon impact"
  carbonWeighting: String! @site(a: "pasi:pred/carbonWeighting")
}

"""
ACE description of furniture
"""
type AceFurnitureDescription {
  id: ID!
  "The furniture category"
  category: String! @site(a: "pasi:pred/category")
  "The furniture sub-category"
  subcategory: String! @site(a: "pasi:pred/subcategory")
  "The weight in kilograms of an average item of this furniture subcategory"
  itemKg: Float! @site(a: "pasi:pred/itemKg")
  "The records for mapping this ACE data to reference data"
  refDataConnectors: [OpsAceToRefData]
    @site(
      q: {
        edn:
        """
        {:find [e]
          :where [[e :pasi:pred/type "OpsAceToRefData"]
                  [e :pasi:pred/description object]]
         }
        """}
    )
}

"""
ACE reused furniture
"""
type AceReusedFurniture {
  id: ID!
  "The start of the period, inclusive"
  from: Date! @site(a: "pasi:pred/from")
  "The end of the period, exclusive"
  to: Date! @site(a: "pasi:pred/to")
  "The description of the reused furniture"
  description: AceFurnitureDescription 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "AceFurnitureDescription"]
                   [object {keyword: "pasi:pred/description"} e]]
         }
    )
  "The number of items of furniture reused"
  itemCount: Int! @site(a: "pasi:pred/itemCount")
}

"""
STCMF source
"""
type StcmfSource {
  id: ID!
  "Where the food material came from"
  name: String! @site(a: "pasi:pred/name")
}

"""
STCMF destination
"""
type StcmfDestination {
  id: ID!
  "How the food material got used"
  name: String! @site(a: "pasi:pred/name")
  "The records for mapping this STCMF data to reference data"
  refDataConnectors: [OpsStcmfToRefData]
    @site(
      q: {
        edn:
        """
        {:find [e]
          :where [[e :pasi:pred/type "OpsStcmfToRefData"]
                  [e :pasi:pred/destination object]]
         }
        """}
    )
}

"""
STCMF batches of incoming food
"""
type StcmfIncomingFood {
  id: ID!
  "The start of the period, inclusive"
  from: Date! @site(a: "pasi:pred/from")
  "The end of the period, exclusive"
  to: Date! @site(a: "pasi:pred/to")
  "The source of the food material"
  source: StcmfSource
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "StcmfSource"]
                   [object {keyword: "pasi:pred/source"} e]]
         }
    )
  "The weight in kilograms of this batch of food material"
  batchKg: Float! @site(a: "pasi:pred/batchKg")
}

"""
STCMF batches of redistributed food
"""
type StcmfRedistributedFood {

  id: ID!

  "The start of the period, inclusive"
  from: Date! @site(a: "pasi:pred/from")

  "The end of the period, exclusive"
  to: Date! @site(a: "pasi:pred/to")

  "How the food material got used"
  destination: StcmfDestination
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "StcmfDestination"]
                   [object {keyword: "pasi:pred/destination"} e]]
         }
    )
    
  "The weight in kilograms of this batch of food material"
  batchKg: Float! @site(a: "pasi:pred/batchKg")
}

"""
FRSHR material (i.e. items) category 
"""
type FrshrMaterialCategory {

  id: ID!

  "The name of this category"
  name: String! @site(a: "pasi:pred/name")

  "The records for mapping this FRSHR data to reference data"
  refDataConnectors: [OpsFrshrToRefData]
    @site(
      q: {
        edn:
        """
        {:find [e]
          :where [[e :pasi:pred/type "OpsFrshrToRefData"]
                  [e :pasi:pred/material object]]
         }
        """}
    )
}

"""
FRSHR batches of reused material, i.e. batches of a particular category of item, which have been (re)sold
"""
type FrshrReusedMaterial {

  id: ID!

  "The start of the period, inclusive"
  from: Date! @site(a: "pasi:pred/from")

  "The end of the period, exclusive"
  to: Date! @site(a: "pasi:pred/to")

  "The 'material' (i.e. category of item) that was reused"
  material: FrshrMaterialCategory
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "FrshrMaterialCategory"]
                   [object {keyword: "pasi:pred/material"} e]]
         }
    )
    
  "The weight in kilograms of this batch of reused material"
  batchKg: Float! @site(a: "pasi:pred/batchKg")
}

"""
OPS ACE data to reference data
Aside:
  OpsAceToRefData (etc.) will need to be better named if we expand on the social impacts.
  E.g.  OpsAceToRefData -> OpsAceToWasteReductionRefData
    since if we expand into the accounting of employment reduction as a social impact
    then we might need an OpsAceToUnemploymentReductionRefData
"""
type OpsAceToRefData {
  id: ID!
  "The description of the furniture"
  description: AceFurnitureDescription 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "AceFurnitureDescription"]
                   [object {keyword: "pasi:pred/description"} e]]
         }
    )
  "The fraction of this ACE material in 1 of the reference material"
  fraction: Float! @site(a: "pasi:pred/fraction")
  "Map to this reference process"
  refProcess: OpsProcess 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsProcess"]
                   [object {keyword: "pasi:pred/refProcess"} e]]
         }
    )
  "Map to this reference material"
  refMaterial: ZwsCarbonMetric 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "ZwsCarbonMetric"]
                   [object {keyword: "pasi:pred/refMaterial"} e]]
         }
    )
  "The organisation that has enabled/facilitated the social impact"
  enabler: OpsOrg 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsOrg"]
                   [object {keyword: "pasi:pred/enabler"} e]]
         }
    )
}

"""
OPS STCMF data to reference data
"""
type OpsStcmfToRefData {
  id: ID!
  "The description of the furniture"
  destination: StcmfDestination 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "StcmfDestination"]
                   [object {keyword: "pasi:pred/destination"} e]]
         }
    )
  "The fraction of this STCMF material in 1 of the reference material"
  fraction: Float! @site(a: "pasi:pred/fraction")
  "Map to this reference process"
  refProcess: OpsProcess 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsProcess"]
                   [object {keyword: "pasi:pred/refProcess"} e]]
         }
    )
  "Map to this reference material"
  refMaterial: ZwsCarbonMetric 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "ZwsCarbonMetric"]
                   [object {keyword: "pasi:pred/refMaterial"} e]]
         }
    )
  "The organisation that has enabled/facilitated the social impact"
  enabler: OpsOrg 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsOrg"]
                   [object {keyword: "pasi:pred/enabler"} e]]
         }
    )
}

"""
OPS FRSHR data to reference data
"""
type OpsFrshrToRefData {

  id: ID!

  "The 'material' (i.e. category of item) that was reused"
  material: FrshrMaterialCategory
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "FrshrMaterialCategory"]
                   [object {keyword: "pasi:pred/material"} e]]
         }
    )

  "The fraction of this FRSHR material in 1 of the reference material"
  fraction: Float! @site(a: "pasi:pred/fraction")

  "Map to this reference process"
  refProcess: OpsProcess 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsProcess"]
                   [object {keyword: "pasi:pred/refProcess"} e]]
         }
    )

  "Map to this reference material"
  refMaterial: ZwsCarbonMetric 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "ZwsCarbonMetric"]
                   [object {keyword: "pasi:pred/refMaterial"} e]]
         }
    )

  "The organisation that has enabled/facilitated the social impact"
  enabler: OpsOrg 
    @site(
      q: { find: [e]
           where: [[e {keyword: "pasi:pred/type"} "OpsOrg"]
                   [object {keyword: "pasi:pred/enabler"} e]]
         }
    )
}

"""
OPS referenced organisation
"""
type OpsOrg {
  id: ID!
  "The abbrevation of the organisation (used as a 'handle')"
  abbr: String! @site(a: "pasi:pred/abbr")
  "The name of the organisation"
  name: String! @site(a: "pasi:pred/name")
  "WikiData's Q Identifier for the organisation"
  qid: String! @site(a: "pasi:pred/qid")
}

"""
OPS waste reduction process
"""
type OpsProcess {
  id: ID!
  "The name of a means by which waste can be reduced"
  name: String! @site(a: "pasi:pred/name")
}

"""
OPS waste reduction
"""
union OpsWasteReduction = AceReusedFurniture | StcmfRedistributedFood | FrshrReusedMaterial

