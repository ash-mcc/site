{"version":3,"sources":["dcs/pasi/app/view/unauthenticated/tmp.cljs"],"mappings":"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","names":["dcs.pasi.app.view.unauthenticated.tmp/load-from-server","url","js/window.location.hostname","model","dcs.pasi.model/queries","graphql","results-parser","field-order","response-handler","response","status","cljs.core.not_EQ_","cljs.core.ex_info","coll","cljs.core/vals","cljs.core/first","p1__60878#","G__60879","cljs.core.map","cljs.core.assoc","cljs.core.sort_by","cljs.core/reverse","cljs.core/reset!","dcs.pasi.app.state/unauthn-wr-ds-cursor","dcs.pasi.app.query/http-call","js/Error","dcs.pasi.app.view.unauthenticated.tmp/filter-ds","wr-ds","selected-years","selected-orgs","selected-streams","cljs.spec.alpha.valid_QMARK_","cljs.core/set?","p1__60880#","cljs.core.filter","cljs.core/seq","clojure.set.intersection","from","cljs.core.subs","js/parseInt","to","clojure.string/starts-with?","p1__60881#","cljs.core/contains?","p1__60882#","dcs.pasi.app.view.unauthenticated.tmp/wasteStreams","dcs.pasi.app.view.unauthenticated.tmp/geojson-template","cljs.core.apply","cljs.core/array-map","cljs.core.interleave","p1__60883#","cljs.core.range","dcs.pasi.app.view.unauthenticated.tmp/->geojson-as-a-clj-structure","ds","js/console.log","cljs.core/count","cljs.core/group-by","p__60886","vec__60887","cljs.core.nth","enabler","cljs.core.keep_indexed","idx","wasteStream","v","p1__60884#","cljs.core._EQ_","cljs.core/+","cljs.core.into","features","p1__60885#","cljs.core/PersistentHashMap"],"sourcesContent":["(ns dcs.pasi.app.view.unauthenticated.tmp\n  (:require    [cljs.spec.alpha :as s]\n               [clojure.set :as set]\n               [clojure.string :as str]\n               [dcs.pasi.app.state :as state]\n               [dcs.pasi.model :as model]\n               [dcs.pasi.app.query :as query]))\n\n\n\n(defn load-from-server []\n  (let [url (str \"http://\" js/window.location.hostname \":2021/pasi/graphql\")\n                      model (:dcsWasteReduction model/queries)\n                      graphql (:graphql model)\n                      results-parser    (:results-parser model)\n                      field-order       (:field-order model)\n                      response-handler (fn [response] \n                                         (let [status (:status response)]\n                                           (when (not= 200 status)\n                                             (throw (ex-info (str \"Error code: \" status) {})))\n                                           (let [coll (-> response\n                                                          :body\n                                                          ;; assume that it was an application/json response \n                                                          ;; which will have prompted cljs-http to have \n                                                          ;; converted the JSON data in the body, to Clojure data\n                                                          :data\n                                                          ;; assume a map with a single entry: get the value of that entry\n                                                          vals\n                                                          first\n                                                          ;; parse each possibly nested map to surface the wanted data in the top map\n                                                          results-parser\n                                                          (->> \n                                                           ;; add a status column\n                                                           (map #(assoc % :status \"loaded from server\"))\n                                                           (sort-by :to)\n                                                           reverse))]\n                                             (reset! state/unauthn-wr-ds-cursor coll))))]\n                  (query/http-call url graphql response-handler)))\n\n\n(defn filter-ds \n  [wr-ds selected-years selected-orgs selected-streams]\n  {:pre [(s/valid? set? selected-years)\n         (s/valid? set? selected-orgs)\n         (s/valid? set? selected-streams)]}\n  (->> wr-ds\n       (filter #(seq (set/intersection selected-years \n                                       (let [from (-> % :from (subs 0 4) js/parseInt)\n                                             to   (when (not (str/starts-with? (:to %) \"01-01-\"))\n                                                    (-> % :to (subs 0 4) js/parseInt))]\n                                         #{from to}))))\n       (filter #(contains? selected-orgs (:enabler %)))\n       (filter #(contains? selected-streams (:wasteStream %)))))\n\n\n(def wasteStreams ;; TODO remove this hardcoding\n  [\"Textiles\"\n   \"Textiles and Footwear\"\n   \"Aluminium cans and foil\"\n   \"Footwear\"\n   \"Mixed Cans\"\n   \"Scrap Metal\"\n   \"Steel Cans\"\n   \"PET (including forming)\"\n   \"WEEE - Small\"\n   \"WEEE - Mixed\"\n   \"WEEE - Large\"\n   \"PS (including forming)\"\n   \"Wood\"\n   \"Average Plastics\"\n   \"Average plastic rigid (including bottles)\"\n   \"HDPE (including forming)\"\n   \"LDPE and LLDPE (including forming)\"\n   \"Average plastic film (including bags)\"\n   \"PP (including forming)\"\n   \"PVC (including forming)\"\n   \"Board\"\n   \"Mixed paper and board\"\n   \"Paper\"\n   \"Books\"\n   \"Mineral Oil\"\n   \"WEEE - Fridges and Freezers\"\n   \"Food and Drink Waste (wet AD)\"\n   \"Food and Drink Waste (Composting)\"\n   \"Batteries (Post Consumer Non Automotive)\"\n   \"Glass (colour separated)\"\n   \"Mixed Food and Garden Waste (dry AD)\"\n   \"Garden Waste (dry AD)\"\n   \"Mixed Food and Garden Waste (Composting)\"\n   \"Garden Waste Composting\"\n   \"Glass (mixed colours)\"\n   \"Plasterboard\"\n   \"Aggregates (Rubble)\"])\n\n(def geojson-template {:type       \"FeatureCollection\"\n                       :features   []\n                       :properties {:fields      {\"n\" {:name \"Site name\"}\n                                                  \"r\" {:name \"Region\"}\n                                                  \"p\" {:name \"Permit\"}\n                                                  \"s\" {:name \"Status\"}\n                                                  \"a\" {:name \"Activities\"}\n                                                  \"k\" {:name \"Accepts\"}\n                                                  \"t\" {:lookup (apply array-map\n                                                                      (interleave (map #(str \"m\" %) (range))\n                                                                                  wasteStreams))\n                                                       :name   \"Materials\"}\n                                                  \"z\" {:name \"Total incoming tonnes\"}}\n                                    :attribution \"SEPA\",\n                                    :description \"Waste site locations and the quantities of incoming materials (2019)\"}})\n\n;; Example of a ds (containing 1 record) that has been restructed ready to be turned into a geojson oriented Feature record \n#_({:enabler                            \"The Fair Share\"\n  :latitude                           \"56.146389\"\n  :longitude                          \"-3.919833\"\n  :per-wasteStream-carbonSavingCo2eKg {\"m34\" 2868.330419999999\n                                       \"m25\" 0\n                                       \"m8\"  18442.849840000003\n                                       \"m11\" 0\n                                       \"m27\" 0\n                                       \"m20\" 0\n                                       \"m3\"  0\n                                       \"m7\"  0\n                                       \"m12\" 4137.0327\n                                       \"m4\"  943.6153999999997\n                                       \"m13\" 9685.26552\n                                       \"m15\" 7935.50175\n                                       \"m17\" 443.4934500000001\n                                       \"m33\" 0\n                                       \"m0\"  0\n                                       \"m28\" 384.8385\n                                       \"m9\"  0\n                                       \"m26\" 16967.29245\n                                       \"m36\" 117.01556999999998\n                                       \"m29\" 0\n                                       \"m16\" 0\n                                       \"m19\" 0\n                                       \"m10\" 4465.179\n                                       \"m32\" 0\n                                       \"m23\" 31551.068070000005\n                                       \"m30\" 0\n                                       \"m2\"  193311.91663000002\n                                       \"m35\" 0\n                                       \"m6\"  0\n                                       \"m24\" 0\n                                       \"m1\"  1586281.4197999998\n                                       \"m18\" 0\n                                       \"m14\" 0\n                                       \"m21\" 3930.29872\n                                       \"m31\" 0\n                                       \"m5\"  20312.238950000003\n                                       \"m22\" 0}\n  :total-carbonSavingCo2eKg           1901777.35677})\n\n(defn ->geojson-as-a-clj-structure [ds]\n  (js/console.log (str \"->geojson-as-a-clj-structure encoding \" (count ds) \" rows\"))\n  (let [ds (->> ds\n                (group-by :enabler)\n                (map (fn [[enabler coll]] {:enabler                            enabler\n                                           :latitude                           (-> coll first :latitude)\n                                           :longitude                          (-> coll first :longitude)\n                                           :per-wasteStream-carbonSavingCo2eKg (->> wasteStreams\n                                                                                    (keep-indexed\n                                                                                     (fn [idx wasteStream] (let [v (->> coll\n                                                                                                                        (filter #(= wasteStream (:wasteStream %)))\n                                                                                                                        (map :carbonSavingCo2eKg)\n                                                                                                                        (apply +))]\n                                                                                                             [(str \"m\" idx) v])))\n                                                                                    (into {}))\n                                           :total-carbonSavingCo2eKg           (->> coll\n                                                                                    (map :carbonSavingCo2eKg)\n                                                                                    (apply +))})))\n        ; _ (js/console.log (str ds))\n        \n        ;; Encode as GeoJSON oriented feature records\n        features (map #(hash-map :geometry {:type        \"Point\"\n                                            :coordinates [(:longitude %) (:latitude %)]}\n                                 :type \"Feature\"\n                                 :properties {\"n\" (:enabler %)\n                                              \"r\" \"region\"\n                                              \"p\" \"permit\"\n                                              \"s\" \"status\"\n                                              \"a\" \"activities\"\n                                              \"k\" \"accepts\"\n                                              \"t\" (:per-wasteStream-carbonSavingCo2eKg %) ;tonnes-incoming \n                                              \"z\" (:total-carbonSavingCo2eKg %) ;tonnes-incoming-total\n                                              })\n                      ds)]\n    (assoc geojson-template :features features)))\n\n\n"]}